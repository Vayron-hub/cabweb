<div class="container">
  <!-- Header -->
  <div class="header">
    <h1>Gesti√≥n de Productos</h1>
    <p>Administre el cat√°logo de productos del sistema CAB</p>
  </div>

  <!-- Products Section -->
  <div class="products-section">
    <!-- Section Header -->
    <div class="section-header">
      <h2 class="section-title">
        <span>üì¶</span>
        Productos
        <span *ngIf="pagedResponse" class="text-sm text-gray-500">
          ({{ pagedResponse.totalRecords }} total)
        </span>
      </h2>
      <div class="controls-group">
        <button class="btn btn-secondary" (click)="refreshProducts()">
          üîÑ Actualizar
        </button>
        <button class="btn btn-secondary" (click)="exportProductsData()">
          üìÅ Exportar
        </button>
        <button class="btn btn-primary" (click)="openAddProductModal()">
          ‚ûï Agregar Producto
        </button>
      </div>
    </div>

    <!-- Filters Section -->
    <div class="filters-section">
      <div class="filters-grid">
        <div class="filter-group">
          <label class="filter-label">Buscar productos</label>
          <input
            type="text"
            class="filter-input"
            placeholder="Buscar por nombre o descripci√≥n..."
            [(ngModel)]="filtros.searchTerm"
            (keyup.enter)="onSearchChange()"
            (blur)="onSearchChange()"
          />
        </div>
        
        <div class="filter-group">
          <label class="filter-label">Estado</label>
          <select
            class="filter-input"
            [(ngModel)]="filtros.statusFilter"
            (change)="onStatusFilterChange($event)"
          >
            <option value="all">Todos los estados</option>
            <option value="active">Activos</option>
            <option value="inactive">Inactivos</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label class="filter-label">Stock</label>
          <select
            class="filter-input"
            [(ngModel)]="filtros.stockFilter"
            (change)="onStockFilterChange($event)"
          >
            <option value="all">Todo el stock</option>
            <option value="in-stock">En stock</option>
            <option value="low-stock">Stock bajo</option>
            <option value="out-of-stock">Sin stock</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label class="filter-label">Por p√°gina</label>
          <select
            class="filter-input"
            [(ngModel)]="filtros.pageSize"
            (change)="onPageSizeChange($event)"
          >
            <option value="5">5 productos</option>
            <option value="10">10 productos</option>
            <option value="25">25 productos</option>
            <option value="50">50 productos</option>
          </select>
        </div>
        
        <div class="filter-group">
          <button class="btn btn-secondary" (click)="resetFilters()">
            üîÑ Limpiar Filtros
          </button>
        </div>
      </div>
    </div>

    <!-- Bulk Actions -->
    <div class="bulk-actions" *ngIf="selectedProductos.length > 0">
      <span class="bulk-actions-text">
        {{ selectedProductos.length }} producto(s) seleccionado(s)
      </span>
      <button class="btn btn-secondary" (click)="bulkActivateProducts()">
        ‚úÖ Activar
      </button>
      <button class="btn btn-secondary" (click)="bulkDeactivateProducts()">
        ‚ùå Desactivar
      </button>
      <button class="btn btn-danger" (click)="bulkDeleteProducts()">
        üóëÔ∏è Eliminar
      </button>
    </div>

    <!-- Loading State -->
    <div class="loading-container" *ngIf="isLoadingProductos">
      <div class="loading-spinner"></div>
      <p>Cargando productos...</p>
    </div>

    <!-- Products Table -->
    <div class="table-container" *ngIf="!isLoadingProductos && productos.length > 0">
      <table class="products-table">
        <thead>
          <tr>
            <th>
              <input
                type="checkbox"
                [checked]="allProductsSelected()"
                [indeterminate]="someProductsSelected()"
                (change)="selectAllProducts($event)"
              />
            </th>
            <th (click)="onSortChange('nombre')" style="cursor: pointer;">
              Producto
              <i class="fas {{ getSortIcon('nombre') }}"></i>
            </th>
            <th (click)="onSortChange('precio')" style="cursor: pointer;">
              Precio
              <i class="fas {{ getSortIcon('precio') }}"></i>
            </th>
            <th>Costo</th>
            <th (click)="onSortChange('stock')" style="cursor: pointer;">
              Stock
              <i class="fas {{ getSortIcon('stock') }}"></i>
            </th>
            <th>Estado</th>
            <th (click)="onSortChange('fechaCreacion')" style="cursor: pointer;">
              Fecha Creaci√≥n
              <i class="fas {{ getSortIcon('fechaCreacion') }}"></i>
            </th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let producto of productos; trackBy: trackByProductId">
            <td>
              <input
                type="checkbox"
                [checked]="selectedProductos.includes(producto.id)"
                (change)="toggleProductSelection(producto.id, $event)"
              />
            </td>
            
            <td>
              <div class="product-info">
                <div class="product-image">
                  <img 
                    *ngIf="producto.imagen" 
                    [src]="producto.imagen" 
                    [alt]="producto.nombre" 
                    style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;"
                  />
                  <span *ngIf="!producto.imagen">üì¶</span>
                </div>
                <div class="product-details">
                  <h4>{{ producto.nombre }}</h4>
                  <p [title]="producto.descripcion">{{ producto.descripcion }}</p>
                </div>
              </div>
            </td>
            
            <td>
              <div class="price-info">
                <span class="price">{{ formatPrice(producto.precio) }}</span>
                <span class="cost" *ngIf="producto.margen">
                  Margen: {{ producto.margen | number:'1.1-1' }}%
                </span>
              </div>
            </td>
            
            <td>
              <span class="cost">{{ formatPrice(producto.costo) }}</span>
            </td>
            
            <td>
              <div style="display: flex; flex-direction: column; gap: 4px;">
                <span class="stock-badge" [ngClass]="getStockStatusClass(producto.stock)">
                  {{ producto.stock }}
                </span>
                <small class="text-gray-500">{{ producto.estadoStock || getStockStatusText(producto.stock) }}</small>
              </div>
            </td>
            
            <td>
              <span class="status-badge" [ngClass]="getStatusClass(producto.activo)">
                {{ producto.estado || getStatusText(producto.activo) }}
              </span>
            </td>
            
            <td>{{ formatDate(producto.fechaCreacion) }}</td>
            
            <td>
              <div class="actions-group">
                <button 
                  class="btn-small btn-edit" 
                  (click)="openEditProductModal(producto)"
                  title="Editar producto"
                >
                  ‚úèÔ∏è
                </button>
                <button 
                  class="btn-small btn-edit" 
                  (click)="duplicateProduct(producto)"
                  title="Duplicar producto"
                >
                  üìã
                </button>
                <button 
                  class="btn-small btn-toggle" 
                  (click)="toggleProductStatus(producto)"
                  [title]="producto.activo ? 'Desactivar producto' : 'Activar producto'"
                >
                  {{ producto.activo ? "‚ùå" : "‚úÖ" }}
                </button>
                <button 
                  class="btn-small btn-delete" 
                  (click)="deleteProduct(producto)"
                  title="Eliminar producto"
                >
                  üóëÔ∏è
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="!isLoadingProductos && productos.length === 0">
      <div class="empty-icon">üì¶</div>
      <h3 class="empty-title">
        {{ filtros.searchTerm || filtros.statusFilter !== 'all' || filtros.stockFilter !== 'all' 
           ? 'No se encontraron productos' 
           : 'No hay productos registrados' }}
      </h3>
      <p class="empty-text">
        {{ filtros.searchTerm || filtros.statusFilter !== 'all' || filtros.stockFilter !== 'all'
           ? 'Intente ajustar los filtros de b√∫squeda'
           : 'Comience agregando su primer producto al sistema' }}
      </p>
      <button 
        *ngIf="!filtros.searchTerm && filtros.statusFilter === 'all' && filtros.stockFilter === 'all'"
        class="btn btn-primary" 
        (click)="openAddProductModal()" 
        style="margin-top: 20px"
      >
        ‚ûï Agregar Primer Producto
      </button>
      <button 
        *ngIf="filtros.searchTerm || filtros.statusFilter !== 'all' || filtros.stockFilter !== 'all'"
        class="btn btn-secondary" 
        (click)="resetFilters()" 
        style="margin-top: 20px"
      >
        üîÑ Limpiar Filtros
      </button>
    </div>

    <!-- Pagination -->
    <div class="pagination-section" *ngIf="pagedResponse && pagedResponse.totalPages > 1">
      <div class="pagination">
        <button
          class="pagination-btn"
          [disabled]="!pagedResponse.hasPreviousPage"
          (click)="goToPage(pagedResponse.currentPage - 1)"
        >
          ‚¨ÖÔ∏è Anterior
        </button>
        
        <button
          *ngFor="let page of getPaginationPages()"
          class="pagination-btn"
          [class.active]="page === pagedResponse.currentPage"
          (click)="goToPage(page)"
        >
          {{ page }}
        </button>
        
        <span class="pagination-info">
          {{ pagedResponse.currentPage }} de {{ pagedResponse.totalPages }}
          ({{ pagedResponse.totalRecords }} total)
        </span>
        
        <button
          class="pagination-btn"
          [disabled]="!pagedResponse.hasNextPage"
          (click)="goToPage(pagedResponse.currentPage + 1)"
        >
          Siguiente ‚û°Ô∏è
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para agregar/editar producto -->
<div class="modal-overlay" *ngIf="showProductModal" (click)="closeProductModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3 class="modal-title">
        {{ editingProduct ? "Editar Producto" : "Agregar Producto" }}
      </h3>
      <button class="modal-close" (click)="closeProductModal()">‚úï</button>
    </div>
    
    <div class="modal-body">
      <form #productFormRef="ngForm" (ngSubmit)="saveProduct()">
        <div class="form-grid">
          <!-- Nombre -->
          <div class="form-group">
            <label class="form-label">Nombre *</label>
            <input
              type="text"
              class="form-input"
              name="nombre"
              [(ngModel)]="productForm.nombre"
              required
              placeholder="Ej: ESP32-CAM"
              [class.error]="formErrors['nombre']"
            />
            <span *ngIf="formErrors['nombre']" class="error-message">
              {{ formErrors['nombre'] }}
            </span>
          </div>

          <!-- Descripci√≥n -->
          <div class="form-group full-width">
            <label class="form-label">Descripci√≥n *</label>
            <textarea
              class="form-input form-textarea"
              name="descripcion"
              [(ngModel)]="productForm.descripcion"
              required
              placeholder="Descripci√≥n detallada del producto..."
              [class.error]="formErrors['descripcion']"
            ></textarea>
            <span *ngIf="formErrors['descripcion']" class="error-message">
              {{ formErrors['descripcion'] }}
            </span>
          </div>

          <!-- Precio -->
          <div class="form-group">
            <label class="form-label">Precio * (MXN)</label>
            <input
              type="number"
              class="form-input"
              name="precio"
              [(ngModel)]="productForm.precio"
              required
              placeholder="0.00"
              step="0.01"
              min="0.01"
              [class.error]="formErrors['precio']"
            />
            <span *ngIf="formErrors['precio']" class="error-message">
              {{ formErrors['precio'] }}
            </span>
          </div>

          <!-- Costo -->
          <div class="form-group">
            <label class="form-label">Costo (MXN)</label>
            <input
              type="number"
              class="form-input"
              name="costo"
              [(ngModel)]="productForm.costo"
              placeholder="0.00"
              step="0.01"
              min="0"
              [class.error]="formErrors['costo']"
            />
            <span *ngIf="formErrors['costo']" class="error-message">
              {{ formErrors['costo'] }}
            </span>
            <small class="text-gray-500">
              Margen estimado: 
              <span *ngIf="productForm.precio && productForm.costo && productForm.precio > 0">
                {{ ((productForm.precio - productForm.costo) / productForm.precio * 100) | number:'1.1-1' }}%
              </span>
              <span *ngIf="!productForm.precio || !productForm.costo || productForm.precio <= 0">
                N/A
              </span>
            </small>
          </div>

          <!-- Stock -->
          <div class="form-group">
            <label class="form-label">Stock Inicial</label>
            <input
              type="number"
              class="form-input"
              name="stock"
              [(ngModel)]="productForm.stock"
              placeholder="0"
              min="0"
              [class.error]="formErrors['stock']"
            />
            <span *ngIf="formErrors['stock']" class="error-message">
              {{ formErrors['stock'] }}
            </span>
          </div>

          <!-- Imagen -->
          <div class="form-group full-width">
            <label class="form-label">URL de Imagen</label>
            <input
              type="url"
              class="form-input"
              name="imagen"
              [(ngModel)]="productForm.imagen"
              placeholder="https://ejemplo.com/imagen.jpg"
              [class.error]="formErrors['imagen']"
            />
            <span *ngIf="formErrors['imagen']" class="error-message">
              {{ formErrors['imagen'] }}
            </span>
          </div>

          <!-- Vista previa de imagen -->
          <div class="form-group full-width" *ngIf="productForm.imagen">
            <label class="form-label">Vista previa</label>
            <div style="text-align: center; padding: 10px; border: 1px dashed #ccc; border-radius: 8px;">
              <img 
                [src]="productForm.imagen" 
                [alt]="productForm.nombre || 'Vista previa'"
                style="max-width: 200px; max-height: 150px; border-radius: 8px;"
                (error)="onImageError($event)"
              />
            </div>
          </div>

          <!-- Estado activo -->
          <div class="form-group full-width">
            <div class="form-checkbox">
              <input
                type="checkbox"
                class="checkbox-input"
                name="activo"
                [(ngModel)]="productForm.activo"
                id="productActive"
              />
              <label for="productActive" class="form-label">
                Producto activo
                <small class="text-gray-500">
                  (Los productos inactivos no aparecer√°n en las ventas)
                </small>
              </label>
            </div>
          </div>
        </div>
      </form>
    </div>
    
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeProductModal()">
        Cancelar
      </button>
      <button
        type="button"
        class="btn btn-primary"
        (click)="saveProduct()"
        [disabled]="!productFormRef.valid || isLoadingProductos"
      >
        <span *ngIf="isLoadingProductos">‚è≥</span>
        {{ editingProduct ? "Actualizar Producto" : "Guardar Producto" }}
      </button>
    </div>
  </div>
</div>

<!-- Estilos adicionales para errores y mejoras -->
<style>
  .error-message {
    color: #ef4444;
    font-size: 0.85rem;
    margin-top: 4px;
    display: block;
  }

  .form-input.error {
    border-color: #ef4444;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
  }

  .text-gray-500 {
    color: #6b7280;
  }

  .text-sm {
    font-size: 0.875rem;
  }

  .pagination-info {
    font-size: 0.9rem;
    padding: 10px 16px;
  }

  /* Mejorar la responsividad de la tabla */
  @media (max-width: 768px) {
    .product-details p {
      max-width: 150px;
    }
    
    .actions-group {
      flex-direction: column;
      gap: 4px;
    }
    
    .btn-small {
      font-size: 0.75rem;
      padding: 6px 8px;
    }
  }

  /* Animaciones suaves */
  .products-table tr {
    transition: background-color 0.2s ease;
  }

  .btn {
    transition: all 0.2s ease;
  }

  /* Mejoras visuales */
  .status-badge, .stock-badge {
    transition: all 0.2s ease;
  }

  .loading-container p {
    margin-top: 15px;
    color: #6b7280;
    font-weight: 500;
  }
</style>