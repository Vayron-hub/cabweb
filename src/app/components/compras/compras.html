<div class="max-w-7xl mx-auto p-5 space-y-8">
  <div class="bg-white rounded-2xl shadow-sm p-8 border-l-4 border-emerald-600">
    <h1 class="text-3xl font-bold text-gray-800 mb-2">Gestión de Compras</h1>
    <p class="text-gray-500 text-sm">
      Administre compras de materias primas a proveedores
    </p>
  </div>

  <!-- Tarjeta de conteo: Total vs Resultados -->
  <div class="bg-white rounded-2xl shadow-sm p-6 border border-emerald-100">
    <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
      <div
        class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 p-6 border-b border-gray-200"
      >
        <div class="flex items-center gap-3">
          <div
            class="w-12 h-12 rounded-xl bg-emerald-100 text-emerald-600 flex items-center justify-center text-2xl"
          >
            <i class="pi pi-box"></i>
          </div>
          <div>
            <h2 class="text-xl font-semibold text-gray-800">Compras</h2>
            <p class="text-xs text-gray-500">
              {{filteredCompras.length}} resultado(s)
            </p>
          </div>
        </div>
        <div class="flex flex-wrap gap-3">
          <button
            (click)="openAddCompraModal()"
            class="inline-flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white font-medium px-5 py-2.5 rounded-xl text-sm shadow"
          >
            <i class="pi pi-plus"></i> Nuevo
          </button>
          <!-- <button
          (click)="exportMaterialsData()"
          class="inline-flex items-center gap-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium px-5 py-2.5 rounded-xl text-sm"
        >
          <i class="pi pi-download"></i> Exportar
        </button> -->
          <button
            (click)="loadMateriasPrimas()"
            [disabled]="isLoadingCompras"
            class="inline-flex items-center gap-2 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-medium px-5 py-2.5 rounded-xl text-sm disabled:opacity-50"
          >
            <i
              class="pi"
              [ngClass]="isLoadingCompras ? 'pi-spin pi-spinner' : 'pi-refresh'"
            ></i>
            {{isLoadingCompras ? 'Actualizando...' : 'Actualizar'}}
          </button>
        </div>
      </div>

      <!-- Filtros -->
      <div class="p-6 bg-gray-50 border-b border-gray-200">
        <div class="grid gap-5 md:grid-cols-4">
          <div class="flex flex-col gap-2">
            <label class="text-xs font-medium text-gray-600">Buscar</label>
            <input
              type="text"
              [(ngModel)]="searchTerm"
              (input)="onSearchChange()"
              placeholder="Número o proveedor..."
              class="w-full rounded-xl border border-gray-300 px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
            />
          </div>
          <div class="flex flex-col gap-2">
            <label class="text-xs font-medium text-gray-600">Estado</label>
            <select
              [(ngModel)]="selectedStatusFilter"
              (change)="onStatusFilterChange($event)"
              class="w-full rounded-xl border border-gray-300 px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
            >
              <option value="all">Todos</option>
              <option *ngFor="let s of statuses" [value]="s">{{ s }}</option>
            </select>
          </div>
          <div class="flex flex-col gap-2">
            <label class="text-xs font-medium text-gray-600">Proveedor</label>
            <select
              [ngModel]="selectedProveedorFilter"
              (ngModelChange)="onProveedorFilterChange({ target: { value: $event } })"
              class="w-full rounded-xl border border-gray-300 px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
            >
              <option value="all">Todos</option>
              <option *ngFor="let p of proveedores" [value]="p.id">
                {{ p.nombre }}
              </option>
            </select>
          </div>
          <div class="flex items-end">
            <button
              (click)="clearFilters()"
              class="w-full inline-flex items-center justify-center gap-2 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-medium px-5 py-2.5 rounded-xl text-sm"
            >
              <i class="pi pi-filter-slash"></i>
              Limpiar filtros
            </button>
          </div>
        </div>
      </div>

      <!-- Loading -->
      <div
        *ngIf="isLoadingCompras"
        class="flex flex-col items-center justify-center py-24 gap-4"
      >
        <i class="pi pi-spin pi-spinner text-3xl text-emerald-500"></i>
        <p class="text-sm text-gray-500">Cargando compras...</p>
      </div>

      <!-- Tabla -->
      <div
        *ngIf="!isLoadingCompras && filteredCompras.length > 0"
        class="overflow-x-auto"
      >
        <table class="min-w-full text-sm">
          <thead>
            <tr class="bg-gray-50 text-gray-600">
              <th class="px-6 py-3 text-left font-semibold">#</th>
              <th class="px-6 py-3 text-left font-semibold">Fecha</th>
              <th class="px-6 py-3 text-left font-semibold">Proveedor</th>
              <th class="px-6 py-3 text-left font-semibold">SubTotal</th>
              <th class="px-6 py-3 text-left font-semibold">Total</th>
              <th class="px-6 py-3 text-left font-semibold">Estado</th>
              <th class="px-6 py-3 text-right font-semibold">Acciones</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            <tr
              *ngFor="let c of getPaginatedCompras(); trackBy: trackByCompraId"
              class="hover:bg-gray-50"
            >
              <td class="px-6 py-3 font-medium text-gray-800">
                {{ c.numeroCompra }}
              </td>
              <td class="px-6 py-3 text-gray-700">
                {{ formatDate(c.fechaCompra) }}
              </td>
              <td class="px-6 py-3 text-gray-700">
                {{ c.proveedor?.nombre || '-' }}
              </td>
              <td class="px-6 py-3 text-gray-700">
                {{ formatPrice(c.subTotal) }}
              </td>
              <td class="px-6 py-3 text-gray-700">
                {{ formatPrice(c.total) }}
              </td>
              <td class="px-6 py-3">
                <span
                  class="px-2.5 py-1 rounded-full text-xs font-medium"
                  [ngClass]="getStatusClass(c.estatus)"
                  >{{ getStatusText(c.estatus) }}</span
                >
              </td>
              <td class="px-6 py-3">
                <div class="flex items-center justify-end gap-2">
                  <button
                    (click)="openEditCompraModal(c)"
                    class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs bg-gray-100 hover:bg-gray-200 text-gray-700"
                  >
                    <i class="pi pi-pencil"></i>
                  </button>
                  <button
                    (click)="deleteCompra(c)"
                    class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs bg-rose-100 hover:bg-rose-200 text-rose-700"
                  >
                    <i class="pi pi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Empty state -->
      <div
        *ngIf="!isLoadingCompras && filteredCompras.length === 0"
        class="py-24 flex flex-col items-center justify-center text-center gap-4"
      >
        <div
          class="w-20 h-20 rounded-full bg-gray-100 flex items-center justify-center text-4xl text-gray-400"
        >
          <i class="pi pi-inbox"></i>
        </div>
        <h3 class="text-lg font-semibold text-gray-700">
          No hay compras registradas
        </h3>
        <p class="text-sm text-gray-500 max-w-md">
          Cree una nueva compra para comenzar a registrar el inventario de
          materias primas.
        </p>
        <button
          (click)="openAddCompraModal()"
          class="inline-flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white font-medium px-5 py-2.5 rounded-xl text-sm shadow"
        >
          <i class="pi pi-plus"></i>
          Nueva compra
        </button>
      </div>

      <!-- Paginación -->
      <div
        *ngIf="!isLoadingCompras && filteredCompras.length > 0"
        class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 p-6 border-t border-gray-200"
      >
        <div class="text-xs text-gray-500">{{ getPaginationInfo() }}</div>
        <div class="flex items-center gap-2">
          <button
            (click)="goToPreviousPage()"
            [disabled]="!canGoToPreviousPage()"
            class="px-3 py-1.5 text-sm rounded-lg border border-gray-300 text-gray-700 disabled:opacity-50"
          >
            Anterior
          </button>
          <button
            (click)="goToNextPage()"
            [disabled]="!canGoToNextPage()"
            class="px-3 py-1.5 text-sm rounded-lg border border-gray-300 text-gray-700 disabled:opacity-50"
          >
            Siguiente
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Crear/Editar Compra -->
  <div
    *ngIf="showCompraModal"
    class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 p-4"
    (click)="closeCompraModal()"
  >
    <div
      class="bg-white rounded-2xl shadow-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto animate-slide-up"
      (click)="$event.stopPropagation()"
    >
      <div
        class="flex items-center justify-between p-6 border-b border-gray-200"
      >
        <h3 class="text-xl font-semibold text-gray-800">
          {{ editingCompra ? 'Editar compra' : 'Nueva compra' }}
        </h3>
        <button
          class="w-9 h-9 rounded-lg flex items-center justify-center hover:bg-gray-100 text-gray-500"
          (click)="closeCompraModal()"
        >
          <i class="pi pi-times"></i>
        </button>
      </div>
      <form
        class="p-6 space-y-6"
        (ngSubmit)="saveCompra()"
        #compraFormRef="ngForm"
      >
        <!-- Datos generales -->
        <div class="grid md:grid-cols-3 gap-5">
          <div class="flex flex-col gap-2" *ngIf="editingCompra">
            <label class="text-xs font-medium text-gray-600"
              >Número de compra</label
            >
            <input
              type="text"
              [(ngModel)]="compraForm.numeroCompra"
              name="numeroCompra"
              readonly
              class="w-full bg-gray-50 rounded-xl border border-gray-300 px-4 py-2.5 text-sm text-gray-700"
            />
          </div>
          <div class="flex flex-col gap-2">
            <label class="text-xs font-medium text-gray-600">Fecha</label>
            <input
              type="date"
              [(ngModel)]="compraForm.fechaCompra"
              name="fechaCompra"
              required
              class="w-full rounded-xl border border-gray-300 px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
            />
          </div>
          <div class="flex flex-col gap-2">
            <label class="text-xs font-medium text-gray-600">Proveedor</label>
            <select
              [(ngModel)]="compraForm.proveedorId"
              name="proveedorId"
              (ngModelChange)="onProveedorCompraChange($event)"
              required
              class="w-full rounded-xl border border-gray-300 px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
            >
              <option [ngValue]="null" disabled>Seleccione...</option>
              <option *ngFor="let p of proveedores" [ngValue]="p.id">
                {{ p.nombre }}
              </option>
            </select>
          </div>
        </div>

        <div class="flex flex-col gap-2">
          <label class="text-xs font-medium text-gray-600">Observaciones</label>
          <textarea
            [(ngModel)]="compraForm.observaciones"
            name="observaciones"
            rows="2"
            class="w-full rounded-xl border border-gray-300 px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
          ></textarea>
        </div>

        <!-- Detalles -->
        <div class="space-y-3">
          <div class="flex items-center justify-between">
            <h4 class="font-semibold text-gray-800">Detalles</h4>
            <button
              type="button"
              (click)="addDetalleRow()"
              class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs bg-emerald-600 hover:bg-emerald-700 text-white"
            >
              <i class="pi pi-plus"></i>
              Agregar línea
            </button>
          </div>

          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead>
                <tr class="bg-gray-50 text-gray-600">
                  <th class="px-4 py-2 text-left font-semibold">Proveedor</th>
                  <th class="px-4 py-2 text-left font-semibold">
                    Materia prima
                  </th>
                  <th class="px-4 py-2 text-left font-semibold">Cantidad</th>
                  <th class="px-4 py-2 text-left font-semibold">
                    Precio unitario
                  </th>
                  <th class="px-4 py-2 text-left font-semibold">Subtotal</th>
                  <th class="px-4 py-2 text-right font-semibold">Acciones</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100">
                <tr
                  *ngFor="let d of compraForm.detalles; let i = index"
                  class="hover:bg-gray-50"
                >
                  <td class="px-4 py-2">
                    <select
                      [(ngModel)]="d.proveedorId"
                      name="proveedor_{{i}}"
                      class="w-full rounded-xl border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
                    >
                      <option [ngValue]="null" disabled>Seleccione...</option>
                      <option *ngFor="let p of proveedores" [ngValue]="p.id">{{ p.nombre }}</option>
                    </select>
                  </td>
                  <td class="px-4 py-2">
                    <select
                      [(ngModel)]="d.materiaPrimaId"
                      name="materiaPrima_{{i}}"
                      (change)="onDetalleChange(i)"
                      class="w-full rounded-xl border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
                    >
                      <option [ngValue]="null" disabled>Seleccione...</option>
                      <option *ngFor="let m of materiasPrimas" [ngValue]="m.id">
                        {{ m.nombre }}
                      </option>
                    </select>
                  </td>
                  <td class="px-4 py-2">
                    <input
                      type="number"
                      min="1"
                      [(ngModel)]="d.cantidad"
                      name="cantidad_{{i}}"
                      (input)="onDetalleChange(i)"
                      class="w-28 rounded-xl border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
                    />
                  </td>
                  <td class="px-4 py-2">
                    <input
                      type="number"
                      min="0"
                      step="0.01"
                      [(ngModel)]="d.precioUnitario"
                      name="precio_{{i}}"
                      (input)="onDetalleChange(i)"
                      class="w-32 rounded-xl border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
                    />
                  </td>
                  <td class="px-4 py-2 text-gray-700">
                    {{ formatPrice(d.subTotal || 0) }}
                  </td>
                  <td class="px-4 py-2 text-right">
                    <button
                      type="button"
                      (click)="removeDetalleRow(i)"
                      class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs bg-rose-100 hover:bg-rose-200 text-rose-700"
                    >
                      <i class="pi pi-trash"></i>
                      Eliminar
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Totales -->
        <div
          class="flex flex-col md:flex-row md:items-center md:justify-between gap-4"
        >
          <div class="flex items-center gap-3" *ngIf="editingCompra">
            <label class="text-xs font-medium text-gray-600">Estado</label>
            <select
              [(ngModel)]="compraForm.estatus"
              name="estatus"
              class="rounded-xl border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
            >
              <option *ngFor="let s of statuses" [ngValue]="s">{{ getStatusText(s) }}</option>
            </select>
          </div>
          <div class="ml-auto space-y-1 text-right">
            <div class="text-sm text-gray-600">
              Subtotal:
              <span class="font-semibold text-gray-800"
                >{{ formatPrice(compraForm.subTotal) }}</span
              >
            </div>
            <div class="text-base text-gray-700">
              Total:
              <span class="font-bold text-gray-900"
                >{{ formatPrice(compraForm.total) }}</span
              >
            </div>
          </div>
        </div>

        <div class="flex justify-end gap-3 pt-2">
          <button
            type="button"
            class="inline-flex items-center gap-2 px-4 py-2 rounded-xl text-sm border border-gray-300 text-gray-700 hover:bg-gray-50"
            (click)="closeCompraModal()"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="inline-flex items-center gap-2 px-4 py-2 rounded-xl text-sm bg-emerald-600 hover:bg-emerald-700 text-white"
          >
            <i class="pi pi-save"></i>
            Guardar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
