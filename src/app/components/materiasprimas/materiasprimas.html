<div class="max-w-7xl mx-auto p-5 space-y-8">
  <div class="bg-white rounded-2xl shadow-sm p-8 border-l-4 border-emerald-600">
    <h1 class="text-3xl font-bold text-gray-800 mb-2">
      Gestión de Materias Primas
    </h1>
    <p class="text-gray-500 text-sm">
      Administre los componentes y materiales del sistema CAB
    </p>
  </div>

  <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
    <div
      class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 p-6 border-b border-gray-200"
    >
      <div class="flex items-center gap-3">
        <div
          class="w-12 h-12 rounded-xl bg-emerald-100 text-emerald-600 flex items-center justify-center text-2xl"
        >
          <i class="pi pi-box"></i>
        </div>
        <div>
          <h2 class="text-xl font-semibold text-gray-800">Materias Primas</h2>
          <p class="text-xs text-gray-500">
            {{filteredMaterials.length}} resultado(s)
          </p>
        </div>
      </div>
      <div class="flex flex-wrap gap-3">
        <button
          (click)="openAddMaterialModal()"
          class="inline-flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white font-medium px-5 py-2.5 rounded-xl text-sm shadow"
        >
          <i class="pi pi-plus"></i> Nuevo
        </button>
        <!-- <button
          (click)="exportMaterialsData()"
          class="inline-flex items-center gap-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium px-5 py-2.5 rounded-xl text-sm"
        >
          <i class="pi pi-download"></i> Exportar
        </button> -->
        <button
          (click)="loadMateriasPrimas()"
          [disabled]="isLoadingMaterials"
          class="inline-flex items-center gap-2 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-medium px-5 py-2.5 rounded-xl text-sm disabled:opacity-50"
        >
          <i
            class="pi"
            [ngClass]="isLoadingMaterials ? 'pi-spin pi-spinner' : 'pi-refresh'"
          ></i>
          {{isLoadingMaterials ? 'Actualizando...' : 'Actualizar'}}
        </button>
      </div>
    </div>

    <div class="p-6 bg-gray-50 border-b border-gray-200">
      <div class="grid gap-5 md:grid-cols-4">
        <div class="flex flex-col gap-2">
          <label
            class="text-xs font-semibold uppercase tracking-wide text-gray-500"
            >Buscar</label
          >
          <input
            type="text"
            [(ngModel)]="searchTerm"
            (ngModelChange)="onSearchChange()"
            placeholder="Nombre o descripción..."
            class="px-4 py-2.5 rounded-xl border-2 border-gray-200 focus:outline-none focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 text-sm"
          />
        </div>
        <div class="flex flex-col gap-2">
          <label
            class="text-xs font-semibold uppercase tracking-wide text-gray-500"
            >Estado</label
          >
          <select
            [(ngModel)]="selectedStatusFilter"
            (change)="onStatusFilterChange($event)"
            class="px-4 py-2.5 rounded-xl border-2 border-gray-200 focus:outline-none focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 text-sm"
          >
            <option value="all">Todos</option>
            <option value="active">Activos</option>
            <option value="inactive">Inactivos</option>
          </select>
        </div>
        <div class="flex flex-col gap-2">
          <label
            class="text-xs font-semibold uppercase tracking-wide text-gray-500"
            >Stock</label
          >
          <select
            [(ngModel)]="selectedStockFilter"
            (change)="onStockFilterChange($event)"
            class="px-4 py-2.5 rounded-xl border-2 border-gray-200 focus:outline-none focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 text-sm"
          >
            <option value="all">Todos</option>
            <option value="in-stock">Suficiente (&gt;10)</option>
            <option value="low-stock">Bajo (1-10)</option>
            <option value="out-of-stock">Agotado (0)</option>
          </select>
        </div>
        <div class="flex items-end">
          <button
            (click)="clearFilters()"
            class="w-full inline-flex items-center justify-center gap-2 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-medium px-5 py-2.5 rounded-xl text-sm"
          >
            <i class="pi pi-filter-slash"></i> Limpiar filtros
          </button>
        </div>
      </div>
    </div>

    <div
      *ngIf="selectedMaterials.length > 0"
      class="flex flex-wrap items-center gap-4 px-6 py-4 bg-emerald-50 border-b border-emerald-100"
    >
      <div class="text-sm text-emerald-800 font-medium">
        {{selectedMaterials.length}} seleccionada(s)
      </div>
      <div class="flex flex-wrap gap-2">
        <button
          (click)="bulkActivateMaterials()"
          class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-semibold rounded-lg shadow"
        >
          Activar
        </button>
        <button
          (click)="bulkDeactivateMaterials()"
          class="px-4 py-2 bg-neutral-500 hover:bg-neutral-600 text-white text-xs font-semibold rounded-lg"
        >
          Desactivar
        </button>
        <button
          (click)="bulkDeleteMaterials()"
          class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-xs font-semibold rounded-lg"
        >
          Eliminar
        </button>
      </div>
    </div>

    <div
      *ngIf="isLoadingMaterials"
      class="flex flex-col items-center justify-center py-24 gap-4"
    >
      <i class="pi pi-spin pi-spinner text-3xl text-emerald-500"></i>
      <p class="text-sm text-gray-500">Cargando materias primas...</p>
    </div>

    <div
      *ngIf="!isLoadingMaterials && getPaginatedMaterials().length > 0"
      class="overflow-x-auto"
    >
      <table class="min-w-full text-sm">
        <thead>
          <tr class="bg-gray-50 text-gray-600">
            <th class="px-6 py-4 text-left w-10">
              <input
                type="checkbox"
                (change)="selectAllMaterials($event)"
                [checked]="allMaterialsSelected()"
                class="w-4 h-4 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500"
              />
            </th>
            <th class="px-6 py-4 text-left">Material</th>
            <th class="px-6 py-4 text-left">Stock</th>
            <th class="px-6 py-4 text-center">Estado</th>
            <th class="px-6 py-4 text-right">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let m of getPaginatedMaterials(); trackBy: trackByMaterialId"
            class="border-b border-gray-100 hover:bg-gray-50 transition-colors"
          >
            <td class="px-6 py-3 align-top">
              <input
                type="checkbox"
                (change)="toggleMaterialSelection(m.id, $event)"
                [checked]="selectedMaterials.includes(m.id)"
                class="w-4 h-4 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500"
              />
            </td>
            <td class="px-6 py-3 align-top">
              <div class="flex items-start gap-3">
                <div
                  class="w-10 h-10 rounded-lg bg-emerald-100 text-emerald-600 flex items-center justify-center"
                >
                  <i class="pi pi-box"></i>
                </div>
                <div>
                  <h3 class="font-semibold text-gray-800 leading-tight">
                    {{m.nombre}}
                  </h3>
                  <p class="text-xs text-gray-500 max-w-xs truncate">
                    {{m.descripcion}}
                  </p>
                  <p class="text-[10px] text-gray-400">
                    Creado: {{formatDate(m.fechaCreacion)}}
                  </p>
                </div>
              </div>
            </td>
            <td class="px-6 py-3 align-top">
              <div class="flex items-center gap-2">
                <span
                  [ngClass]="m.stock === 0 ? 'bg-red-100 text-red-700' : (m.stock <= 10 ? 'bg-amber-100 text-amber-700' : 'bg-emerald-100 text-emerald-700')"
                  class="px-2 py-0.5 rounded-full text-[10px] font-semibold tracking-wide uppercase"
                >
                  {{m.stock}}
                  {{ m.stock === 1 ? 'pieza' : 'piezas' }}
                </span>
              </div>
            </td>
            <td class="px-6 py-3 align-top text-center">
              <span
                [ngClass]="m.activo ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'"
                class="px-3 py-1 rounded-full text-[10px] font-semibold tracking-wide uppercase"
                >{{getStatusText(m.activo)}}</span
              >
            </td>
            <td class="px-6 py-3 align-top">
              <div class="flex justify-end gap-2">
                <button
                  (click)="openEditMaterialModal(m)"
                  title="Editar"
                  class="p-2 rounded-lg bg-primary-100 hover:bg-primary-200 text-primary-600 text-xs"
                >
                  <i class="pi pi-pencil"></i>
                </button>
                <button
                  (click)="toggleMaterialStatus(m)"
                  title="{{m.activo ? 'Desactivar' : 'Activar'}}"
                  class="p-2 rounded-lg bg-neutral-100 hover:bg-neutral-200 text-neutral-600 text-xs"
                >
                  <i
                    class="pi"
                    [ngClass]="m.activo ? 'pi-ban' : 'pi-check'"
                  ></i>
                </button>
                <button
                  (click)="deleteMaterial(m)"
                  title="Eliminar"
                  class="p-2 rounded-lg bg-danger-100 hover:bg-danger-200 text-danger-600 text-xs"
                >
                  <i class="pi pi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Empty state -->
    <div
      *ngIf="!isLoadingMaterials && filteredMaterials.length === 0"
      class="py-24 flex flex-col items-center justify-center text-center gap-4"
    >
      <div
        class="w-20 h-20 rounded-full bg-gray-100 flex items-center justify-center text-4xl text-gray-400"
      >
        <i class="pi pi-box"></i>
      </div>
      <h3 class="text-lg font-semibold text-gray-700">
        No se encontraron materias primas
      </h3>
      <p class="text-sm text-gray-500 max-w-md">
        Prueba ajustando los filtros o agrega una nueva materia prima al
        sistema.
      </p>
      <button
        (click)="openAddMaterialModal()"
        class="inline-flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white font-medium px-5 py-2.5 rounded-xl text-sm shadow"
      >
        <i class="pi pi-plus"></i> Agregar primera
      </button>
    </div>

    <div
      *ngIf="!isLoadingMaterials && filteredMaterials.length > 0"
      class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 p-6 border-t border-gray-200"
    >
      <div class="text-xs text-gray-500">
        Página {{currentPage}} de {{totalPages}}
      </div>
      <div class="flex items-center gap-2">
        <button
          (click)="goToPreviousPage()"
          [disabled]="!canGoToPreviousPage()"
          class="px-3 py-2 rounded-lg border text-xs font-medium disabled:opacity-40 disabled:cursor-not-allowed bg-white hover:bg-gray-50 border-gray-300"
        >
          Anterior
        </button>
        <ng-container
          *ngFor="let page of [].constructor(totalPages); let i = index"
        >
          <button
            (click)="goToPage(i+1)"
            [ngClass]="i+1===currentPage ? 'bg-emerald-600 text-white border-emerald-600' : 'bg-white hover:bg-gray-50 border-gray-300 text-gray-700'"
            class="px-3 py-2 rounded-lg border text-xs font-medium"
          >
            {{i+1}}
          </button>
        </ng-container>
        <button
          (click)="goToNextPage()"
          [disabled]="!canGoToNextPage()"
          class="px-3 py-2 rounded-lg border text-xs font-medium disabled:opacity-40 disabled:cursor-not-allowed bg-white hover:bg-gray-50 border-gray-300"
        >
          Siguiente
        </button>
      </div>
    </div>
  </div>
</div>

<div
  *ngIf="showMaterialModal"
  class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 p-4"
  (click)="closeMaterialModal()"
>
  <div
    class="bg-white rounded-2xl shadow-xl w-full max-w-xl max-h-[90vh] overflow-y-auto animate-slide-up"
    (click)="$event.stopPropagation()"
  >
    <div class="flex items-center justify-between p-6 border-b border-gray-200">
      <h3 class="text-xl font-semibold text-gray-800">
        {{editingMaterial ? 'Editar Materia Prima' : 'Nueva Materia Prima'}}
      </h3>
      <button
        (click)="closeMaterialModal()"
        class="w-9 h-9 rounded-lg flex items-center justify-center hover:bg-gray-100 text-gray-500"
      >
        <i class="pi pi-times"></i>
      </button>
    </div>
    <form
      class="p-6 space-y-6"
      (ngSubmit)="saveMaterial()"
      #materialFormRef="ngForm"
    >
      <div class="grid md:grid-cols-2 gap-5">
        <div class="flex flex-col gap-2 md:col-span-2">
          <label
            class="text-xs font-semibold uppercase tracking-wide text-gray-500"
            >Nombre *</label
          >
          <input
            type="text"
            [(ngModel)]="materialForm.nombre"
            name="nombre"
            required
            class="px-4 py-2.5 rounded-xl border-2 border-gray-200 focus:outline-none focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 text-sm"
          />
        </div>
        <div class="flex flex-col gap-2 md:col-span-2">
          <label
            class="text-xs font-semibold uppercase tracking-wide text-gray-500"
            >Descripción *</label
          >
          <textarea
            [(ngModel)]="materialForm.descripcion"
            name="descripcion"
            rows="3"
            required
            class="px-4 py-2.5 rounded-xl border-2 border-gray-200 focus:outline-none focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 text-sm resize-y"
          ></textarea>
        </div>
        <div class="flex flex-col gap-2 md:col-span-2">
          <label
            class="text-xs font-semibold uppercase tracking-wide text-gray-500"
            >Stock *</label
          >
          <input
            type="number"
            min="0"
            [(ngModel)]="materialForm.stock"
            name="stock"
            required
            class="px-4 py-2.5 rounded-xl border-2 border-gray-200 focus:outline-none focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 text-sm"
          />
        </div>
        <div class="flex items-center gap-3" *ngIf="editingMaterial">
          <input
            type="checkbox"
            [(ngModel)]="materialForm.activo"
            name="activo"
            class="w-5 h-5 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500"
          />
          <span class="text-sm text-gray-700">Activo</span>
        </div>
      </div>
      <div class="flex justify-end gap-2">
        <button
          type="button"
          (click)="closeMaterialModal()"
          class="px-5 py-2.5 rounded-xl bg-gray-100 hover:bg-gray-200 text-gray-600 text-sm font-medium"
        >
          Cancelar
        </button>
        <button
          type="submit"
          [disabled]="!isValidMaterialForm()"
          class="px-5 py-2.5 rounded-xl bg-emerald-600 hover:bg-emerald-700 disabled:opacity-50 text-white text-sm font-medium inline-flex items-center gap-2"
        >
          <i class="pi pi-save"></i> {{editingMaterial ? 'Actualizar' :
          'Guardar'}}
        </button>
      </div>
    </form>
  </div>
</div>
